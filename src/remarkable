import pandas as pd

from loguru import logger

def out_of_sync(file: dict, db: pd.DataFrame) -> bool:
    db_entry = db[db.uuid == file["uuid"]]
    if len(db_entry) == 0:
        return True
    if len(db_entry) > 1:
        logger.error("We have too many entries for this file!")
        return False
    db_entry = db_entry.iloc[0].to_dict()
    return db_entry["last_synced"] < file["last_modified"]
    

def file_to_process(db: pd.DataFrame) -> pd.DataFrame:
    with open_ssh_connection() as conn:
        files = load_files(conn)
    return [file for file in files if out_of_sync(file, db)]